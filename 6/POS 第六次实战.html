<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.2 (452688)"/><meta name="keywords" content="POS实战"/><meta name="author" content="Ivan"/><meta name="created" content="2015-11-04 15:27:02 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2015-11-11 06:25:01 +0000"/><meta name="application-data:starred" content="0"/><title>POS 第六次实战</title></head><body>
<div><span style="color: rgb(68, 68, 68); font-family: 'Lucida Grande', Arial, sans-serif; font-size: small; font-style: normal; font-variant: normal; font-weight: 300; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;">实战1：在内核模块中增加浮点运算，编译选项采用-mhard-float和-msoft-float分别进行处理，查看反汇编结果，解释原因（1分）</span>
<div><span style="color: rgb(68, 68, 68); font-family: 'Lucida Grande', Arial, sans-serif; font-size: small; font-style: normal; font-variant: normal; font-weight: 300; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;">实战2：学习arch/x86/kernel/traps.c中的异常入口，分解do_invalid_op宏</span></div>
<div><span style="color: rgb(68, 68, 68); font-family: 'Lucida Grande', Arial, sans-serif; font-size: small; font-style: normal; font-variant: normal; font-weight: 300; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;">              根据自己VM的ISA，找到一条没有使用的编码，引发SIGILL（1分）</span></div>
<div><span style="color: rgb(68, 68, 68); font-family: 'Lucida Grande', Arial, sans-serif; font-size: small; font-style: normal; font-variant: normal; font-weight: 300; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;">              然后增加该编码的模拟实现，打印一句HelloWorld（1分）</span></div>
</div>
<div><span style="color: rgb(68, 68, 68); font-family: 'Lucida Grande', Arial, sans-serif; font-size: small; font-style: normal; font-variant: normal; font-weight: 300; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;">实战3：限定某个用户的程序运行在一个cpu上（要求使用setaffinity）（1分）</span></div>
<hr/>
<div><span style="font-family: Helvetica, arial, sans-serif;"><span style="font-size: 24px;"><b>实战1</b></span></span></div>
<div>
<div style="-webkit-print-color-adjust: exact; background-color: rgb(248, 248, 248); border: 1px solid rgb(204, 204, 204); font-size: 13px; overflow: auto; padding: 6px 10px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="-webkit-print-color-adjust: exact; padding: 0px; border: none; background-color: transparent; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-position: initial initial; background-repeat: initial initial;">/*<br/>
 *  fprint.c <br/>
 */<br/>
#include &lt;linux/module.h&gt;<br/>
#include &lt;linux/moduleparam.h&gt;<br/>
#include &lt;linux/kernel.h&gt;<br/>
#include &lt;linux/init.h&gt;<br/>
#include &lt;linux/printk.h&gt;<br/>
#include &lt;linux/random.h&gt;<br/>
<br/>
MODULE_LICENSE("GPL");<br/>
MODULE_AUTHOR("Shuyang Shi");<br/>
<br/>
static int divided = 10;<br/>
module_param(divided, int, 0644);<br/>
<br/>
static int divider = 10;<br/>
module_param(divider, int, 0644);<br/>
<br/>
static int __init fprint_init(void)<br/>
{<br/>
    double c;<br/>
    c = (float)divided / divider;<br/>
    printk(KERN_INFO "%.4lf\n", c);<br/>
    return 0;<br/>
}<br/>
module_init(fprint_init);<br/>
<br/>
static void __exit fprint_exit(void)<br/>
{<br/>
    pr_info("Goodbye, fprint module\n");<br/>
}<br/>
module_exit(fprint_exit);</code></div>
</div>
<div><br/></div>
<div>
<p style="-webkit-print-color-adjust: exact; color: rgb(0, 0, 0); font-family: Helvetica, arial, sans-serif; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><em style="-webkit-print-color-adjust: exact;">-msoft-float -msse</em></p>
<div style="-webkit-print-color-adjust: exact; background-color: rgb(248, 248, 248); border: 1px solid rgb(204, 204, 204); font-size: 13px; overflow: auto; padding: 6px 10px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="-webkit-print-color-adjust: exact; padding: 0px; border: none; background-color: transparent; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-position: initial initial; background-repeat: initial initial;">fprint.o:     file format elf64-x86-64<br/>
<br/>
<br/>
Disassembly of section .init.text:<br/>
<br/>
0000000000000000 &lt;init_module&gt;:<br/>
   0:   f3 0f 2a 0d 00 00 00    cvtsi2ssl 0x0(%rip),%xmm1        # 8 &lt;init_module+0x8&gt;<br/>
   7:   00 <br/>
   8:   f3 0f 2a 05 00 00 00    cvtsi2ssl 0x0(%rip),%xmm0        # 10 &lt;init_module+0x10&gt;<br/>
   f:   00 <br/>
  10:   f3 0f 5e c1             divss  %xmm1,%xmm0<br/>
  14:   55                      push   %rbp<br/>
  15:   48 89 e5                mov    %rsp,%rbp<br/>
  18:   e8 00 00 00 00          callq  1d &lt;init_module+0x1d&gt;<br/>
  1d:   48 c7 c7 00 00 00 00    mov    $0x0,%rdi<br/>
  24:   b0 01                   mov    $0x1,%al<br/>
  26:   e8 00 00 00 00          callq  2b &lt;init_module+0x2b&gt;<br/>
  2b:   31 c0                   xor    %eax,%eax<br/>
  2d:   5d                      pop    %rbp<br/>
  2e:   c3                      retq   <br/>
<br/>
Disassembly of section .exit.text:<br/>
<br/>
0000000000000000 &lt;cleanup_module&gt;:<br/>
   0:   55                      push   %rbp<br/>
   1:   48 c7 c7 00 00 00 00    mov    $0x0,%rdi<br/>
   8:   31 c0                   xor    %eax,%eax<br/>
   a:   48 89 e5                mov    %rsp,%rbp<br/>
   d:   e8 00 00 00 00          callq  12 &lt;cleanup_module+0x12&gt;<br/>
  12:   5d                      pop    %rbp<br/>
  13:   c3                      retq   </code></div>
</div>
<div><br/></div>
<div>
<p style="-webkit-print-color-adjust: exact; color: rgb(0, 0, 0); font-family: Helvetica, arial, sans-serif; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><em style="-webkit-print-color-adjust: exact;">-mhard-float</em></p>
<div style="-webkit-print-color-adjust: exact; background-color: rgb(248, 248, 248); border: 1px solid rgb(204, 204, 204); font-size: 13px; overflow: auto; padding: 6px 10px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">
<div><span style="background-color: transparent;">fprint.o:     file format elf64-x86-64</span></div>
<code style="-webkit-print-color-adjust: exact; padding: 0px; border: none; background-color: transparent; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-position: initial initial; background-repeat: initial initial;"><br/>
<br/>
Disassembly of section .init.text:<br/>
<br/>
0000000000000000 &lt;init_module&gt;:<br/>
   0:   55                      push   %rbp<br/>
   1:   48 c7 c7 00 00 00 00    mov    $0x0,%rdi<br/>
   8:   31 c0                   xor    %eax,%eax<br/>
   a:   48 89 e5                mov    %rsp,%rbp<br/>
   d:   48 83 ec 10             sub    $0x10,%rsp<br/>
  11:   db 05 00 00 00 00       fildl  0x0(%rip)        # 17 &lt;init_module+0x17&gt;<br/>
  17:   da 3d 00 00 00 00       fidivrl 0x0(%rip)        # 1d &lt;init_module+0x1d&gt;<br/>
  1d:   dd 1c 24                fstpl  (%rsp)<br/>
  20:   e8 00 00 00 00          callq  25 &lt;init_module+0x25&gt;<br/>
  25:   31 c0                   xor    %eax,%eax<br/>
  27:   c9                      leaveq <br/>
  28:   c3                      retq   <br/>
<br/>
Disassembly of section .exit.text:<br/>
<br/>
0000000000000000 &lt;cleanup_module&gt;:<br/>
   0:   55                      push   %rbp<br/>
   1:   48 c7 c7 00 00 00 00    mov    $0x0,%rdi<br/>
   8:   31 c0                   xor    %eax,%eax<br/>
   a:   48 89 e5                mov    %rsp,%rbp<br/>
   d:   e8 00 00 00 00          callq  12 &lt;cleanup_module+0x12&gt;<br/>
  12:   5d                      pop    %rbp<br/>
  13:   c3                      retq </code></div>
</div>
<div><br/></div>
<hr/>
<div><br/></div>
<div>
<div style="-webkit-print-color-adjust: exact; padding: 0px; font-weight: bold; -webkit-font-smoothing: antialiased; cursor: text; font-size: 24px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); color: rgb(0, 0, 0); font-family: Helvetica, arial, sans-serif; font-style: normal; font-variant: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">
<div>实战2</div>
</div>
</div>
<div><br/></div>
<div>do_invalid_op</div>
<div>
<div style="-webkit-print-color-adjust: exact; background-color: rgb(248, 248, 248); border: 1px solid rgb(204, 204, 204); font-size: 13px; overflow: auto; padding: 6px 10px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="-webkit-print-color-adjust: exact; padding: 0px; border: none; background-color: transparent; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-position: initial initial; background-repeat: initial initial;">static void do_error_trap(struct pt_regs *regs, long error_code, char *str,<br/>
              unsigned long trapnr, int signr)<br/>
{<br/>
    enum ctx_state prev_state = exception_enter();<br/>
    siginfo_t info;<br/>
<br/>
    if (notify_die(DIE_TRAP, str, regs, error_code, trapnr, signr) !=<br/>
            NOTIFY_STOP) {<br/>
        conditional_sti(regs);<br/>
        do_trap(trapnr, signr, str, regs, error_code,<br/>
            fill_trap_info(regs, signr, trapnr, &amp;info));<br/>
    }<br/>
<br/>
    exception_exit(prev_state);<br/>
}<br/>
<br/>
#define DO_ERROR(trapnr, signr, str, name)              \<br/>
dotraplinkage void do_##name(struct pt_regs *regs, long error_code) \<br/>
{                                   \<br/>
    do_error_trap(regs, error_code, str, trapnr, signr);        \<br/>
}<br/>
<br/>
DO_ERROR(X86_TRAP_DE,     SIGFPE,  "divide error",      divide_error)<br/>
DO_ERROR(X86_TRAP_OF,     SIGSEGV, "overflow",          overflow)<br/>
DO_ERROR(X86_TRAP_UD,     SIGILL,  "invalid opcode",        invalid_op)<br/>
DO_ERROR(X86_TRAP_OLD_MF, SIGFPE,  "coprocessor segment overrun",coprocessor_segment_overrun)<br/>
DO_ERROR(X86_TRAP_TS,     SIGSEGV, "invalid TSS",       invalid_TSS)<br/>
DO_ERROR(X86_TRAP_NP,     SIGBUS,  "segment not present",   segment_not_present)<br/>
DO_ERROR(X86_TRAP_SS,     SIGBUS,  "stack segment",     stack_segment)<br/>
DO_ERROR(X86_TRAP_AC,     SIGBUS,  "alignment check",       alignment_check)</code></div>
</div>
<div><br/></div>
<div>参考 <a href="http://ref.x86asm.net/geek.html#x0F00">http://ref.x86asm.net/geek.html#x0F00</a> ，找到invalid opcode <b>0x37</b> （不跟在加法之后）</div>
<div><span style="font: 16.0px 'Helvetica Neue'"><img src="POS%20%E7%AC%AC%E5%85%AD%E6%AC%A1%E5%AE%9E%E6%88%98.resources/9FAA4088-CD88-4D34-8895-F5421105B772.png" height="43" width="456"/></span></div>
<div><img src="POS%20%E7%AC%AC%E5%85%AD%E6%AC%A1%E5%AE%9E%E6%88%98.resources/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202015-11-11%2010.12.53.png" height="343" width="701"/></div>
<div>
<div style="-webkit-print-color-adjust: exact; color: rgb(0, 0, 0); font-family: Helvetica, arial, sans-serif; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"/>
<div style="-webkit-print-color-adjust: exact; background-color: rgb(248, 248, 248); border: 1px solid rgb(204, 204, 204); font-size: 13px; overflow: auto; padding: 6px 10px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">
<div>[ 6331.193706] traps: a[6777] trap invalid opcode ip:400652 sp:7ffcfb7811d0 error:0 in a[400000+1000]</div>
</div>
</div>
<div><br/></div>
<div>C语言的 handler program <i>a.c</i></div>
<div>
<div style="-webkit-print-color-adjust: exact; background-color: rgb(248, 248, 248); border: 1px solid rgb(204, 204, 204); font-size: 13px; overflow: auto; padding: 6px 10px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="-webkit-print-color-adjust: exact; padding: 0px; border: none; background-color: transparent; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-position: initial initial; background-repeat: initial initial;">#include &lt;stdio.h&gt;<br/>
#include &lt;stdlib.h&gt;<br/>
#include &lt;signal.h&gt;<br/>
#include &lt;ucontext.h&gt;<br/>
#include &lt;unistd.h&gt;<br/>
#include &lt;setjmp.h&gt;<br/>
<br/>
#define TRY do{ if( !setjmp(ex_buf__) ){<br/>
#define CATCH } else {<br/>
#define ETRY } }while(0)<br/>
#define THROW do { longjmp(ex_buf__, 1); } while(0)<br/>
<br/>
jmp_buf ex_buf__;<br/>
<br/>
void handler (int signo, siginfo_t si, void *data)<br/>
{<br/>
        printf("Hello World from SIGILL!\n");<br/>
        THROW;<br/>
        return;<br/>
}<br/>
<br/>
<br/>
int main()<br/>
{<br/>
        struct sigaction sa, osa;<br/>
        sa.sa_flags = SA_ONSTACK | SA_RESTART | SA_SIGINFO;<br/>
        sa.sa_sigaction = handler;<br/>
        sigaction(SIGILL, &amp;sa, &amp;osa);<br/>
        volatile a;<br/>
        TRY<br/>
                a += 2;<br/>
        CATCH<br/>
                printf("Continue to run ...\n");<br/>
        ETRY;<br/>
        return 0;<br/>
}</code></div>
</div>
<div><br/></div>
<div>修改二进制文件使得objdump -d出来的反汇编片段为</div>
<div>
<div style="-webkit-print-color-adjust: exact; background-color: rgb(248, 248, 248); border: 1px solid rgb(204, 204, 204); font-size: 13px; overflow: auto; padding: 6px 10px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="-webkit-print-color-adjust: exact; padding: 0px; border: none; background-color: transparent; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-position: initial initial; background-repeat: initial initial;">0000000000400635 &lt;main&gt;:<br/>
  400635:       55                      push   %rbp<br/>
  400636:       48 89 e5                mov    %rsp,%rbp<br/>
  400639:       48 81 ec 50 01 00 00    sub    $0x150,%rsp<br/>
  400640:       c7 85 48 ff ff ff 04    movl   $0x18000004,-0xb8(%rbp)<br/>
  400647:       00 00 18 <br/>
  40064a:       48 c7 85 c0 fe ff ff    movq   $0x40060d,-0x140(%rbp)<br/>
  400651:       0d 06 40 00 <br/>
  400655:       48 8d 95 60 ff ff ff    lea    -0xa0(%rbp),%rdx<br/>
  40065c:       48 8d 85 c0 fe ff ff    lea    -0x140(%rbp),%rax<br/>
  400663:       48 89 c6                mov    %rax,%rsi<br/>
  400666:       bf 04 00 00 00          mov    $0x4,%edi<br/>
  40066b:       e8 60 fe ff ff          callq  4004d0 &lt;sigaction@plt&gt;<br/>
  400670:       bf 80 10 60 00          mov    $0x601080,%edi<br/>
  400675:       e8 76 fe ff ff          callq  4004f0 &lt;_setjmp@plt&gt;<br/>
  40067a:       85 c0                   test   %eax,%eax<br/>
  40067c:       75 11                   jne    40068f &lt;main+0x5a&gt;<br/>
  40067e:       8b 85 bc fe ff ff       mov    -0x144(%rbp),%eax<br/>
  400684:       37                      (bad) <br/>
  400685:       06                      (bad) <br/>
  400686:       07                      (bad) <br/>
  400687:       89 85 bc fe ff ff       mov    %eax,-0x144(%rbp)<br/>
  40068d:       eb 0a                   jmp    400699 &lt;main+0x64&gt;<br/>
  40068f:       bf 3d 07 40 00          mov    $0x40073d,%edi<br/>
  400694:       e8 27 fe ff ff          callq  4004c0 &lt;puts@plt&gt;<br/>
  400699:       b8 00 00 00 00          mov    $0x0,%eax<br/>
  40069e:       c9                      leaveq <br/>
  40069f:       c3                      retq   </code></div>
</div>
<div><br/></div>
<div>运行结果</div>
<div>
<div style="-webkit-print-color-adjust: exact; background-color: rgb(248, 248, 248); border: 1px solid rgb(204, 204, 204); overflow: auto; padding: 6px 10px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">
<div><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures">ivan@Ihost:~/kernel/week6$ ./a<br/>
Hello World from SIGILL!<br/>
Continue to run ...</span></div>
<div><span style="font-size: 14px;"><span style="font-family: Menlo;">ivan@Ihost:~/kernel/week6$</span></span></div>
</div>
</div>
<div><br/></div>
<hr/>
<div>
<h2 style="-webkit-print-color-adjust: exact; padding: 0px; font-weight: bold; -webkit-font-smoothing: antialiased; cursor: text; font-size: 24px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); color: rgb(0, 0, 0); font-family: Helvetica, arial, sans-serif; font-style: normal; font-variant: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">实战3</h2>
</div>
<div><b><span style="font-size: 18px;">思路</span></b></div>
<div>
<div style="-webkit-print-color-adjust: exact; background-color: rgb(248, 248, 248); border: 1px solid rgb(204, 204, 204); font-size: 13px; overflow: auto; padding: 6px 10px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="-webkit-print-color-adjust: exact; padding: 0px; border: none; background-color: transparent; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-position: initial initial; background-repeat: initial initial;">/*<br/>
 *  bind.c<br/>
 *<br/>
 *  bind a user's processes to a cpu through<br/>
 *    1). scanning existing processes and bind them;<br/>
 *    2). modifying syscall 'execve' to bind newly forked processes.<br/>
 */</code></div>
</div>
<div><br/></div>
<div><b><span style="font-size: 18px;">注意</span></b></div>
<div><span style="font-size: 17px;"><b>sched_setaffinity</b></span></div>
<div>
<p style="-webkit-print-color-adjust: exact; color: rgb(0, 0, 0); font-family: Helvetica, arial, sans-serif; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">in <em style="-webkit-print-color-adjust: exact;">kernel/sched/core.c</em>, line 4124</p>
<div style="-webkit-print-color-adjust: exact; background-color: rgb(248, 248, 248); border: 1px solid rgb(204, 204, 204); font-size: 13px; overflow: auto; padding: 6px 10px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="-webkit-print-color-adjust: exact; padding: 0px; border: none; background-color: transparent; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; background-position: initial initial; background-repeat: initial initial;">+   EXPORT_SYMBOL(sched_setaffinity);</code></div>
</div>
<div><br/></div>
<div><span style="font-size: 17px;"><b>sys_execve</b></span></div>
<div><span style="color: rgb(34, 34, 34); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;"> </span><code style=" padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; background-color: rgb(238, 238, 238); white-space: pre-wrap; color: rgb(34, 34, 34); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">sys_call_table[ __NR_execve ]</code><span style="color: rgb(34, 34, 34); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;"> actually contains address of </span><code style=" padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; background-color: rgb(238, 238, 238); white-space: pre-wrap; color: rgb(34, 34, 34); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">ptregs_execve</code><span style="color: rgb(34, 34, 34); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;"> (not </span><code style=" padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; background-color: rgb(238, 238, 238); white-space: pre-wrap; color: rgb(34, 34, 34); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">sys_execve</code><span style="color: rgb(34, 34, 34); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;">). It is defined as follows in </span><code style="padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; background-color: rgb(238, 238, 238); color: rgb(34, 34, 34); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">arch/x86/kernel/entry_32.S</code></div>
<div>(<a href="http://stackoverflow.com/questions/15339279/sys-execve-hooking-on-3-5-kernel">http://stackoverflow.com/questions/15339279/sys-execve-hooking-on-3-5-kernel</a>)</div>
<div><br/></div>
<div><span style="color: rgb(34, 34, 34); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;">You can't hook </span><code style=" padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; background-color: rgb(238, 238, 238); white-space: pre-wrap; color: rgb(34, 34, 34); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">execve</code><span style="color: rgb(34, 34, 34); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;"> by modifying the system call table in a such a way as on </span><code style=" padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; background-color: rgb(238, 238, 238); white-space: pre-wrap; color: rgb(34, 34, 34); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">x86_64</code><span style="color: rgb(34, 34, 34); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;"> the </span><code style=" padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; background-color: rgb(238, 238, 238); white-space: pre-wrap; color: rgb(34, 34, 34); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">sys_execve</code><span style="color: rgb(34, 34, 34); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;"> is called from the </span><code style=" padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; background-color: rgb(238, 238, 238); white-space: pre-wrap; color: rgb(34, 34, 34); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">stub_execve</code><span style="color: rgb(34, 34, 34); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;">. So the call chain is </span><code style=" padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; background-color: rgb(238, 238, 238); white-space: pre-wrap; color: rgb(34, 34, 34); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">sys_call_table[NR_execve] -&gt; stub_execve -&gt; sys_execve -&gt; do_execve</code><span style="color: rgb(34, 34, 34); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;"> ... Take a look at </span><a href="http://lxr.linux.no/linux+v3.2.9/arch/x86/kernel/entry_64.S#L710" rel="nofollow" style=" padding: 0px; border: 0px; font-size: 15px; text-decoration: none; cursor: pointer; color: rgb(12, 101, 165); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">stub_execve</a><span style="color: rgb(34, 34, 34); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none;"> on LXR.</span></div>
<div>(<a href="http://stackoverflow.com/questions/8372912/hooking-sys-execve-on-linux-3-x/9672512#9672512">http://stackoverflow.com/questions/8372912/hooking-sys-execve-on-linux-3-x/9672512#9672512</a>)</div>
<div><br/></div>
<div>Adopted Solution:</div>
<div>
<div style="-webkit-print-color-adjust: exact; background-color: rgb(248, 248, 248); border: 1px solid rgb(204, 204, 204); font-size: 13px; overflow: auto; padding: 6px 10px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">
<div><span style="font-family: monospace;">#define NR_sys_execve 11</span></div>
</div>
</div>
<div>use it instead.</div>
<div><br/></div>
<div><b><span style="font-size: 18px;">附模块</span></b></div>
<div><i>bind.c</i></div>
<div>
<div style="-webkit-print-color-adjust: exact; background-color: rgb(248, 248, 248); border: 1px solid rgb(204, 204, 204); overflow: auto; padding: 6px 10px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal;"><span style="font-size: 14px;"><span style="font-family: Menlo;">/*<br/>
 *  bind.c<br/>
 *<br/>
 *  bind a user's processes to a cpu through<br/>
 *    1). scanning existing processes and bind them;<br/>
 *    2). modify syscall 'execve' to bind newly forked processes.<br/>
 */<br/>
<br/>
/*<br/>
 * Copyright (C) 2015 by Shuyang Shi<br/>
 */<br/>
<br/>
/*<br/>
 * The necessary header files<br/>
 */<br/>
#include &lt;linux/kernel.h&gt;<br/>
#include &lt;linux/module.h&gt;<br/>
#include &lt;linux/moduleparam.h&gt;<br/>
#include &lt;linux/unistd.h&gt;<br/>
#include &lt;linux/syscalls.h&gt;<br/>
#include &lt;linux/delay.h&gt;<br/>
#include &lt;asm/cacheflush.h&gt;<br/>
/*<br/>
 * For the current (process) structure, we need<br/>
 * this to know who the current user is.<br/>
 */<br/>
#include &lt;linux/sched.h&gt;<br/>
#include &lt;linux/uaccess.h&gt;<br/>
<br/>
/*<br/>
 * Write Protect Bit (CR0:16)<br/>
 */<br/>
#define CR0_WP 0x00010000<br/>
<br/>
/*<br/>
 * Place of sys_execve based on sys_call_table<br/>
 * Attention: cannot use __NR_execve becuse<br/>
 * it refers to to place of stub_execve.<br/>
 * Actually, the call chain is<br/>
 * sys_call_table[__NR_execve]<br/>
 * -&gt; stub_execve<br/>
 * -&gt; sys_execve<br/>
 * -&gt; do_execve<br/>
 */<br/>
#define NR_sys_execve 11<br/>
<br/>
/*<br/>
 * The system call table (a table of functions).<br/>
 */<br/>
static void **sys_call_table;<br/>
<br/>
void acquire_sys_call_table(void)<br/>
{<br/>
unsigned long ptr;<br/>
unsigned long *p;<br/>
<br/>
for (ptr = (unsigned long)sys_close;<br/>
ptr &lt; (unsigned long)&amp;loops_per_jiffy;<br/>
ptr += sizeof(void *)) {<br/>
p = (unsigned long *)ptr;<br/>
if (p[__NR_close] == (unsigned long)sys_close) {<br/>
pr_info("Found the sys_call_table!!!\n");<br/>
sys_call_table = (void **)p;<br/>
return;<br/>
}<br/>
}<br/>
sys_call_table = NULL;<br/>
}<br/>
<br/>
/*<br/>
 * UID we want to bind - will be filled from the<br/>
 * command line<br/>
 */<br/>
static int uid = 1001;<br/>
module_param(uid, int, 0644);<br/>
<br/>
/*<br/>
 * CPUID we want to bind the user to - will be filled<br/>
 * from the command line<br/>
 */<br/>
static int mycpuid = 1;<br/>
module_param(mycpuid, int, 0644);<br/>
<br/>
/*<br/>
 * function to set affinity<br/>
 */<br/>
extern long sched_setaffinity(pid_t, const struct cpumask *);<br/>
<br/>
/*<br/>
 * A pointer to the original system call. The reason<br/>
 * we keep this, rather than call the original function<br/>
 * is because somebody else might have<br/>
 * replaced the system call before us. Note that this<br/>
 * is not 100% safe, because if another module<br/>
 * replaced sys_open before us, then when we're inserted<br/>
 * we'll call the function in that module - and it<br/>
 * might be removed before we are.<br/>
 *<br/>
 * Another reason for this is that we can't get sys_open.<br/>
 * It's a static variable, so it is not exported.<br/>
 */<br/>
<br/>
asmlinkage long (*original_call_execve)(const char __user *,<br/>
        const char __user *const __user *,<br/>
        const char __user *const __user *);<br/>
<br/>
asmlinkage long our_sys_execve(const char __user *filename,<br/>
        const char __user *const __user *argv,<br/>
        const char __user *const __user *envp)<br/>
{<br/>
        struct cpumask mask;<br/>
        if (uid == current_uid().val) {<br/>
cpumask_clear(&amp;mask);<br/>
        cpumask_set_cpu(mycpuid, &amp;mask);<br/>
if (sched_setaffinity(current-&gt;pid, &amp;mask))<br/>
printk("Cannot set PID %d to CPU %d\n", current-&gt;pid, mycpuid);<br/>
}<br/>
        return original_call_execve(filename, argv, envp);<br/>
}<br/>
<br/>
<br/>
/*<br/>
 * Initialize the module - replace the system call<br/>
 */<br/>
int init_module(void)<br/>
{<br/>
unsigned long cr0;<br/>
struct cpumask mask;<br/>
struct task_struct *task;<br/>
<br/>
/*<br/>
* Warning - too late for it now, but maybe for<br/>
* next time...<br/>
*/<br/>
pr_alert("I'm dangerous. I hope you did a ");<br/>
pr_alert("sync before you insmod'ed me.\n");<br/>
pr_alert("My counterpart, cleanup_module(), is even");<br/>
pr_alert("more dangerous. If\n");<br/>
pr_alert("you value your file system, it will ");<br/>
pr_alert("be \"sync; rmmod\"\n");<br/>
pr_alert("when you remove this module.\n");<br/>
<br/>
/*<br/>
* Scan all existing processes and<br/>
* bind all that belong to user uid<br/>
* to a certain CPU<br/>
*/<br/>
cpumask_set_cpu(mycpuid, &amp;mask);<br/>
for_each_process(task)<br/>
if (task_uid(task).val == uid)<br/>
sched_setaffinity(task-&gt;pid, &amp;mask);<br/>
<br/>
/*<br/>
* Acquire syscall table<br/>
*/<br/>
acquire_sys_call_table();<br/>
if (!sys_call_table) {<br/>
pr_info("Cannot find the system call table!\n");<br/>
return -1;<br/>
}<br/>
<br/>
/*<br/>
* Keep a pointer to the original function in<br/>
* original_call, and then replace the system call<br/>
* in the system call table with our_sys_open<br/>
*/<br/>
cr0 = read_cr0();<br/>
write_cr0(cr0 &amp; ~CR0_WP);<br/>
<br/>
original_call_execve = sys_call_table[NR_sys_execve];<br/>
sys_call_table[NR_sys_execve] = our_sys_execve;<br/>
<br/>
write_cr0(cr0);<br/>
<br/>
/*<br/>
* To get the address of the function for system<br/>
* call foo, go to sys_call_table[__NR_foo].<br/>
*/<br/>
<br/>
pr_info("Binding UID: %d\n", uid);<br/>
<br/>
return 0;<br/>
}<br/>
<br/>
/*<br/>
 * Cleanup - unregister the appropriate file from /proc<br/>
 */<br/>
void cleanup_module(void)<br/>
{<br/>
unsigned long cr0;<br/>
<br/>
/*<br/>
* Return the system call back to normal<br/>
*/<br/>
if (sys_call_table[__NR_execve] != our_sys_execve) {<br/>
pr_alert("Somebody else also played with the ");<br/>
pr_alert("open system call\n");<br/>
pr_alert("The system may be left in ");<br/>
pr_alert("an unstable state.\n");<br/>
}<br/>
<br/>
cr0 = read_cr0();<br/>
write_cr0(cr0 &amp; ~CR0_WP);<br/>
<br/>
sys_call_table[NR_sys_execve] = original_call_execve;<br/>
<br/>
write_cr0(cr0);<br/>
}<br/>
<br/>
/*<br/>
 * Get rid of taint message by declaring code as GPL.<br/>
 */</span></span></span></div>
<div><span style="font-size: 14px;"><span style="font-family: Menlo;">MODULE_LICENSE("GPL");</span></span></div>
</div>
</div>
</body></html>